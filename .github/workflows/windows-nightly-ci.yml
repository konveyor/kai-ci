name: Provision Windows VM using reusable workflow

on: [push]

jobs:
  start-ec2-instance:
    uses: ./.github/workflows/provision-runner.yml
    with:
      ec2-image-id: ami-0b7d4973163feb944
      ec2-instance-type: t2.micro
      security-group-id: sg-0a3e6b53e86d0e69d
      subnet-id: subnet-06113672589e7e836
      ec2-os-type: windows
    secrets:
      aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      github-token: ${{ secrets.GH_RUNNER_API_TOKEN }}

  run-tests:
    needs: start-ec2-instance
    runs-on: ${{ needs.start-ec2-instance.outputs.instance_label }}
    steps:

      - name: Install Chocolatey
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force;
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12;
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        shell: powershell

      - name: Install VSCode
        run: choco install vscode -y
        shell: powershell

      - name: Install Node.js
        run: choco install nodejs -y
        shell: powershell

      - name: Define and Export Node.js and VSCode Paths
        shell: powershell
        run: |
          # Define local variables for paths
          $nodePath = 'C:\Program Files\nodejs'
          $vscodePath = 'C:\Program Files\Microsoft VS Code\bin'
          
          # Check Node.js Path
          if (-Not (Test-Path $nodePath)) {
          Write-Error "Node.js installation path not found at: $nodePath"
          exit 1
          }
          # Check VSCode Path
          if (-Not (Test-Path $vscodePath)) {
          Write-Error "VSCode installation path not found at: $vscodePath"
          exit 1
          }
          
          # Export the paths so they can be used in subsequent steps
          "NODE_PATH=$nodePath" | Out-File -FilePath $env:GITHUB_ENV -Append
          "VSCODE_PATH=$vscodePath" | Out-File -FilePath $env:GITHUB_ENV -Append
          
          # Also update PATH so that Node.js, npm, npx, and VSCode can be called directly
          $newPath = "$env:PATH;$nodePath;$vscodePath"
          [System.Environment]::SetEnvironmentVariable('PATH', $newPath, [System.EnvironmentVariableTarget]::Process)
          # Persist the updated PATH to make it available for subsequent steps
          "PATH=$newPath" | Out-File -FilePath $env:GITHUB_ENV -Append

#      - name: Check Env PATH variable
#        shell: powershell
#        run: echo $env:PATH

#      - name: Verify VSCode and Node.js Installation
#        shell: powershell
#        run: |
#          # Use the exported paths
#          & "$env:VSCODE_PATH\code.exe" --version
#          & "$env:NODE_PATH\node.exe" --version

      - name: Verify VSCode and Node.js Installation
        shell: powershell
        run: |
          code --version
          node --version

      - name: Clone kai-ci repo
        shell: powershell
        run: |
          mkdir ./kai-ci-temp
          cd ./kai-ci-temp
          git clone https://github.com/konveyor/kai-ci.git
          cd kai-ci

      - name: Install npm dependencies
        shell: powershell
        run: |
          & "$env:NODE_PATH\npm.cmd" install .

      - name: Run tests
        shell: powershell
        run: |
          npx playwright test

  stop-ec2-instance:
    needs: [ start-ec2-instance,run-tests ]
    if: always()
    uses: ./.github/workflows/remove-runner.yml
    with:
      ec2-instance-id: ${{ needs.start-ec2-instance.outputs.ec2-instance-id }}
      ec2-runner-label: ${{ needs.start-ec2-instance.outputs.instance_label }}
    secrets:
      aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      github-token: ${{ secrets.GH_RUNNER_API_TOKEN }}